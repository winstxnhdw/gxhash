name: Publish

on:
  release:
    types: published

jobs:
  compare:
    runs-on: ubuntu-slim
    outputs:
      added: ${{ steps.new-files.outputs.added }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6.0.2
        with:
          show-progress: false

      - name: Install uv
        uses: astral-sh/setup-uv@v7.3.1

      - name: Build sdist from current commit
        run: uv build --sdist -o current

      - name: Download sdist from previous release
        run: pip download gxhash --pre -d previous

      - name: List previous sdist files
        run: tar -tf previous/gxhash-*.tar.gz | sed 's|^[^/]*/||' | sort > previous.txt

      - name: List current sdist files
        run: tar -tf current/gxhash-*.tar.gz | sed 's|^[^/]*/||' | sort > current.txt

      - name: Compare sdist files
        id: new-files
        run: echo "added=$(comm -13 previous.txt current.txt | tr '\n' ' ')" > $GITHUB_OUTPUT

  review:
    if: needs.compare.outputs.added
    needs: compare
    runs-on: ubuntu-slim
    environment: staging

    steps:
      - name: Review new files in sdist
        run: |
          echo "New files detected in sdist. Please review the changes."
          echo "Added files:"
          echo "${{ needs.compare.outputs.added }}" | tr ' ' '\n'

  publish:
    if: ${{ !cancelled() && needs.compare.result == 'success' }}
    needs: [compare, review]
    runs-on: ubuntu-slim
    environment:
      name: pypi

    permissions:
      contents: write
      id-token: write

    env:
      UV_ISOLATED: 1
      PYTHONDONTWRITEBYTECODE: 1

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6.0.2
        with:
          ref: ${{ github.event.release.tag_name }}
          show-progress: false

      - name: Install uv
        uses: astral-sh/setup-uv@v7.3.1

      - name: Build sdist
        run: uv build -v --sdist

      - name: Smoke test
        run: uv run -v --no-project --with dist/gxhash-*.tar.gz tests/test_smoke.py

      - name: Publish to PyPI
        run: uv publish

      - name: Undo release
        if: failure()
        run: gh release delete ${{ github.event.release.tag_name }} -y --cleanup-tag
        env:
          GH_TOKEN: ${{ github.token }}
